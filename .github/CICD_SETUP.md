# Настройка автоматического деплоя через GitHub Actions

Этот документ описывает, как настроить автоматическую синхронизацию с сервером при каждом push в ветку `main`.

## Что делает CI/CD

При каждом push в ветку `main`:
1. Код автоматически подтягивается на сервер
2. Устанавливаются зависимости (если изменился package.json)
3. Проект пересобирается
4. PM2 перезапускает приложение
5. Очищается кэш nginx
6. Проверяется доступность сайта

## Настройка GitHub Secrets

Для работы автодеплоя нужно добавить следующие secrets в настройках GitHub репозитория:

### Шаг 1: Создать SSH ключ на сервере

Подключитесь к серверу и выполните:

```bash
ssh root@188.225.73.61
cd ~/.ssh
ssh-keygen -t rsa -b 4096 -C "github-actions" -f github_deploy_key -N ""
cat github_deploy_key.pub >> authorized_keys
cat github_deploy_key
```

Скопируйте содержимое **приватного ключа** (`github_deploy_key`).

### Шаг 2: Добавить secrets в GitHub

Перейдите в настройки репозитория: **Settings → Secrets and variables → Actions → New repository secret**

Добавьте следующие secrets:

| Имя | Значение |
|-----|----------|
| `SSH_PRIVATE_KEY` | Приватный SSH ключ (содержимое файла `github_deploy_key`) |
| `SERVER_IP` | `188.225.73.61` |
| `SERVER_USER` | `root` |
| `PROJECT_PATH` | `/var/www/gatchina_zakroma` |

### Шаг 3: Проверка

После добавления secrets:
1. Сделайте любое изменение в коде
2. Закоммитьте и запушьте в main
3. Перейдите во вкладку **Actions** в GitHub
4. Проверьте статус деплоя

## Безопасность

⚠️ **Важно:**
- Приватный SSH ключ хранится только в GitHub Secrets (зашифрован)
- Ключ используется только для деплоя, не имеет других прав
- После настройки удалите приватный ключ с локальной машины

## Альтернатива: использование пароля (менее безопасно)

Если не хотите настраивать SSH ключи, можно использовать пароль через `sshpass`:

1. Установите `sshpass` на GitHub runner (добавьте в workflow):
```yaml
- name: Install sshpass
  run: sudo apt-get install -y sshpass
```

2. Добавьте secret `SERVER_PASSWORD` со значением `sew-v,1vScDVWu`

3. Измените команду SSH в workflow:
```yaml
sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh ${SERVER_USER}@${SERVER_IP} << 'EOF'
```

⚠️ Этот метод менее безопасен, рекомендуется использовать SSH ключи.

## Мониторинг

Все деплои можно отслеживать во вкладке **Actions** репозитория. При ошибке вы увидите детальные логи.
